---
lab:
    title: 'Lab 10: Explore and analyze time stamped data with Time Series Insights'
    module: 'Module 5: Insights and Business Integration'
---

# Explore and analyze time stamped data with Time Series Insights

## Lab Scenario

Your hard work implementing Azure IoT services and tools has paid off. Contoso has rolled out their "Asset Condition Tracking System" that monitors the environmental conditions of cheese containers during shipment.

Two weeks after launching the new system it has revealed a temperature spike in-transit for a specific shipment. Some of the cheese in the shipment was ruined, but the new system did ensure that the affected cheese wasn't delivered to the customer. Since you know the Azure IoT side of the monitoring system better than anyone, you will lead the investigation.

Management has asked you to determine if the system can be improved, hopefully to the point where it will prevent the loss of product in the future. You correlate the IoT devices' sensor data taken from the trucks and planes used during the shipment. It appears that the temperature in one of the trucks rose unexpectedly in a particular area of the vehicle and created the heat spike in one of the transport containers (which was equipped with an IoT device monitoring temperature and humidity).

Your team decides that further improvements to the monitoring system will require near real-time data exploration and root-cause analysis.

You propose adding Time Series Insights to the Azure IoT solution. This will enable Contoso to quickly store, visualize, and query the large amounts of time series data that are generated by the IoT devices in the trucks, planes, and containers, and to visualize changes over time.

The following resources will be created:

![Lab 10 Architecture](media/LAB_AK_10-architecture.png)

## In This Lab

In this lab, you will complete the following activities:

* Configure the lab prerequisites (create the Azure resources that are required for this lab)
* Create an Azure Time Series Insights (TSI) environment
* Connect to IoT Hub with Time Series Insights (TSI)
* View time series data using the Time Series Insights (TSI) Explorer

## Lab Instructions

### Exercise 1: Configure Lab Prerequisites

This lab assumes the following Azure resources are available:

| Resource Type | Resource Name |
| :-- | :-- |
| Resource Group | @lab.CloudResourceGroup(ResourceGroup1).Name |
| IoT Hub | iot-az220-training-{your-id} |
| Device ID | sensor-th-truck0001 |
| Device ID | sensor-th-airplane0001 |
| Device ID | sensor-th-container0001 |

To ensure these resources are available, complete the following tasks.

1. In the virtual machine environment, open a Microsoft Edge browser window, and then navigate to the following Web address:

    +++https://portal.azure.com/#create/Microsoft.Template/uri/https%3a%2f%2fraw.githubusercontent.com%2fMicrosoftLearning%2fMSLearnLabs-AZ-220-Microsoft-Azure-IoT-Developer%2fmaster%2fAllfiles%2FARM%2Flab10.json+++

    > **NOTE**: Whenever you see the green "T" symbol, for example +++enter this text+++, you can click the associated text and the information will be typed into the current field within the virtual machine environment.

1. When prompted to Sign in using Azure account credentials, enter the following values at the sign in prompts:

    **Username**: +++@lab.CloudPortalCredential(User1).Username+++

    **Password**: +++@lab.CloudPortalCredential(User1).Password+++

    Once you have signed in, the **Custom deployment** page will be displayed.

1. Under **Project details**, in the **Subscription** dropdown, ensure that the "Microsoft Learn Hosting" subscription is selected.

    If you are choosing to use a promotional or personal Azure account, enter the subscription information in the dropdown.

1. In the **Resource group** dropdown, select **@lab.CloudResourceGroup(ResourceGroup1).Name**.

    > **NOTE**: If **@lab.CloudResourceGroup(ResourceGroup1).Name** is not listed:
    >
    > 1. Under the **Resource group** dropdown, click **Create new**.
    > 1. Under **Name**, enter **@lab.CloudResourceGroup(ResourceGroup1).Name**.
    > 1. Click **OK**.

1. Under **Instance details**, in the **Region** dropdown, select the region closest to you.

    > **NOTE**: If the **@lab.CloudResourceGroup(ResourceGroup1).Name** group already exists, the **Region** field is set to the region used by the resource group and is read-only.

1. In the **Your ID** field, enter a unique ID value that includes your initials followed by the current date (using a "YourInitialsYYMMDD" pattern).

    The first part of your unique ID will be your initials in lower-case. The second part will be the last two digits of the current year, the current numeric month, and the current numeric day. For example:

    ccj220101

    During this lab, you will see **{your-id}** listed as part of the suggested resource name whenever you need to enter your unique ID. The **{your-id}** portion of the suggested resource name is a placeholder. You will replace the entire placeholder string (including the **{}**) with your unique value.

1. In the **Course ID** field, enter **az220**.

    +++az220+++

1. To validate the template, click **Review and create**.

1. If validation passes, click **Create**.

    The deployment will start. It will take several minutes to deploy the required Azure resources.

1. While the Azure resources are being created, open a text editor tool (Notepad is accessible from the **Start** menu, under **Windows Accessories**). 

    > **NOTE**: You will be using the text editor to store some configuration values associated with your Azure resources.

1. In your text editor, enter the following text labels:

    +++connectionString-iothub:+++

    +++deviceID-truck:+++

    +++connectionString-truck:+++

    +++deviceID-airplane:+++

    +++connectionString-airplane:+++

    +++deviceID-container:+++

    +++connectionString-container:+++

1. Switch back to the Azure portal window and wait for the deployment to finish.

    You will see a notification when deployment is complete.

    > **NOTE**: If the deployment fails during the createDevice operation, you will finds steps listed below to create the devices manually.

1. Once the deployment has completed, in the left navigation area, to review any output values from the template,  click **Outputs**.

    Make a note of the outputs for use later:

    * connectionString
    * deviceIDs

    > **Note**: The deviceIDs output contains a JSON array with the connection strings for each device. Use the text editor of your choice to record the device names and connection strings:

    ```json
    [
        {
            "name":"createDevice-sensor-thl-truck0001",
            "connectionString":"HostName=iot-az220-training-dm072321.azure-devices.net;DeviceId=sensor-thl-truck0001;SharedAccessKey=yJV1FfKyVg5SBA5M9L3D3u1DqoiINYDaEuXv3KWHekA="
        },
        {
            "name":"createDevice-sensor-thl-airplane0001",
            "connectionString":"HostName=iot-az220-training-dm072321.azure-devices.net;DeviceId=sensor-thl-airplane0001;SharedAccessKey=GN+aU3P4oDAhLddLuCKKwTYkinGwl828KvGQTZwxYMc="
        },
        {
            "name":"createDevice-sensor-thl-container0001",
            "connectionString":"HostName=iot-az220-training-dm072321.azure-devices.net;DeviceId=sensor-thl-container0001;SharedAccessKey=lNZEp9xMYBYOidaDxHZcH9MWdOrDgyhmmUrZYBIhwXg="
        }
    ]
    ```

    > **IMPORTANT**: If the deployment failed during the createDevice operation, the **Outputs** pane will be blank. Complete the following steps to create the required IoT devices and a record of the IoT hub and device connections strings.

    1. On the Azure portal menu, click **Dashboard**.

    1. On the **All resources** tile, to open your IoT hub, click **iot-az220-training-{your-id}**.

    1. On the IoT hub blade, under **Device management**, click **Devices**.

    1. On the Devices page, click **+ Add Device**.

    1. On the Create a device page, under **Device ID**, enter **sensor-th-truck0001**

        +++sensor-th-truck0001+++

    1. At the bottom of the page, click **Save**.

    1. Repeat the previous three steps to create IoT devices with Device IDs of **sensor-th-airplane0001** and **sensor-th-container0001**.

        +++sensor-th-airplane0001+++

        +++sensor-th-container0001+++

    1. On the Devices page, under **Device ID**, click **sensor-th-truck0001**.

        If the device isn't listed, on the Devices page, click **Refresh**.

    1. On the sensor-th-truck0001 page, to the right of the **Device ID** value, click **Copy**, and then save the value to your text editor file.

    1. On the sensor-th-truck0001 page, copy the **Primary Connection String** value, and then save it to your text editor file.

    1. Repeat the previous three steps to record the Device IDs and Primary Connection String values for the **sensor-th-airplane0001** and **sensor-th-container0001** devices.

    1. Navigate back to your IoT hub blade.

    1. On the left side menu, under **Security settings**, click **Shared access policies**.

    1. Click **iothubowner**.

    1. Notice that the IoT hub Primary Connection String is listed.

    1. Copy the value of the IoT hub Primary Connection String and save it to your text editor file.

    The Azure resources required for this lab are now available.

### Exercise 2: Setup Time Series Insights

Azure Time Series Insights (TSI) is an end-to-end platform-as-a-service offering used to collect, process, store, analyze, and query data from IoT solutions at scale. TSI is designed for ad hoc data exploration and operational analysis of data that's highly contextualized and optimized for time series.

In this exercise, you will setup Time Series Insights integration with Azure IoT Hub.

1. In your Azure portal window, navigate to your Dashboard.

1. On the Azure portal menu, click **+ Create a resource**.

1. On the **New** blade, in the **Search the Marketplace** textbox, enter **time series insights**

    +++time series insights+++

1. In the search results, click **Time Series Insights**.

1. On the **Time Series Insights** blade, click **Create**.

1. On the **Create Time Series Insights environment** blade, in the **Subscription** dropdown, select the subscription that you are using for this lab.

1. In the **Resource group** dropdown, click **@lab.CloudResourceGroup(ResourceGroup1).Name**.

1. In the **Environment name** field, enter **tsi-az220-training-{your-id}**

    +++tsi-az220-training-{your-id}+++

    > **Note**: Remember to replace **{your-id}** with your unique ID value.

1. In the **Location** dropdown, select the Azure region used by your resource group.

1. In the **Tier** field, ensure that the **Gen1 (S1)** pricing tier is selected and that **Capacity** is set to **1**.

1. At the bottom of the blade, click **Next: Event Source**.

1. Under the **EVENT SOURCE DETAILS** section, ensure that **Create an event source?** is set to **Yes**.

1. Ensure that **Source type** is set to **IoT Hub**.

1. In the **Name** field, enter **iot-az220-training-{your-id}**

    +++iot-az220-training-{your-id}+++

    > **Note**: Remember to replace **{your-id}** with your unique ID value.

1. in the **Subscription** dropdown, ensure the subscription that you are using for this lab is selected.

1. In the **IoT Hub name** dropdown, select **iot-az220-training-{your-id}**.

1. In the **IoT Hub access policy name** dropdown, click **iothubowner**.

    In a production environment, it's best practice to create a new _Access Policy_ within Azure IoT Hub to use for configuring Time Series Insights (TSI) access. This will enable the security of TSI to be managed independently of any other services connected to the same Azure IoT Hub.  You are not doing that here for convenience reasons.

1. To the right of the **IoT Hub consumer group** dropdown, click **New**.

    The IoT Hub consumer group dropdown will convert to a text entry field so that you can enter a value.

1. In the **IoT Hub consumer group** box, enter **tsievents** and then click **Add**.

    +++tsievents+++

    This will add a new _Consumer Group_ to use for this Event Source. The Consumer Group needs to be used exclusively for this Event Source, as there can only be a single active reader from a given Consumer Group at a time.

1. Under the **Start options** section, in the **Start time** dropdown, ensure that **Beginning now (default)** is selected.

1. Under the **TIMESTAMP** section, leave the **Property Name** blank.

1. At the bottom of the blade, click **Review + create**.

    > **Note**: If you are returned immediately to the *Event Source* pane, double check that you clicked **Add** to the right of the **IoT Hub consumer group** field - you cannot create the TSI resource until you have created the consumer group.

1. At the bottom of the blade, click **Create**.

    > **Note**:  If you are on the **Summary** tab and **Review + create** is displayed at the bottom of the blade, click **Review + create**.

1. Once your Time Series Insights deployment is complete, navigate back to your dashboard.

1. Refresh your resource group tile, and then click **tsi-az220-training-{your-id}**.

    You may need to resize your dashboard to see all of your resources.

    > **Note**: You gave the **Time Series Insights environment** resource the name **tsi-az220-training-{your-id}**. You should also see the *Time Series Insights event source* that you created, but for now you want to have the TSI environment opened.

1. On the **Time Series Insights environment** blade, on the left-side menu under **Settings**, click **Event Sources**.

1. On the **Event Sources** pane, notice the **iot-az220-training-{your-id}** Event Source in the list.

    This is the event source that you configured when the TSI resource was created.

1. To view the event source details, click **iot-az220-training-{your-id}**.

    Notice that the configuration of the event source matches what you specified when the Time Series Insights resource was created.

### Exercise 3: Run Simulated IoT Devices

In this exercise, you will run the simulated devices so that they start sending telemetry events to Azure IoT Hub.

1. In your virtual machine environment, use the **Start** menu to open **Visual Studio Code**.

    > **Tip**: You may find it helpful to maximize the Visual Studio Code window.

1. On the **File** menu, click **Open Folder**.

1. In the **Open Folder** dialog, navigate to the lab 10 Starter folder.

    Before starting the lab instructions, you downloaded a copy of the GitHub repository containing lab resources to the lab virtual machine environment. The folder structure includes the following folder path:

    * Allfiles
        * Labs
            * 10-Explore and analyze time stamped data with Time Series Insights
                * Starter

    > **Note**: If you have trouble locating the **Allfiles** folder, check your Windows **Desktop** folder.

1. In the **Open Folder** dialog, click **ContainerSimulation**, and then click **Select Folder**.

    If prompted, load the C# extension and/or perform a restore.

1. In the EXPLORER pane, to open the Program.cs file, click **Program.cs**.

1. Locate the variables used to assign the connections strings

    ```csharp
    private readonly static string connectionStringTruck = "{Your Truck device connection string here}";
    private readonly static string connectionStringAirplane = "{Your Airplane device connection string here}";
    private readonly static string connectionStringContainer = "{Your Container device connection string here}";
    ```

1. Update the variable assignments with the connection strings that you saved earlier in the lab.

    Be sure to replace the placeholder values with the Connection String for the corresponding IoT device.

1. On the **File** menu, click **Save**.

1. On the **View** menu, click **Terminal**.

1. Within the **Terminal** pane, ensure that the command prompt specifies the path to the lab 10 **/Starter/ContainerSimulation** directory.

1. At the command prompt, to build and run the **ContainerSimulation** app, enter the following command:

    ```cmd/sh
    dotnet run
    ```

1. Notice the messages displayed in the Terminal pane.

    Once the **ContainerSimulation** app is running, it will begin outputting telemetry data to the terminal. This is the telemetry data that it is sending to Azure IoT Hub.

    When the **ContainerSimulation** app is running, the **Terminal** output will look similar to the following:

    ```text
    12/27/2019 8:51:30 PM > Sending TRUCK message: {"temperature":35.15660452608195,"humidity":48.422323938240865}
    12/27/2019 8:51:31 PM > Sending AIRPLANE message: {"temperature":17.126545186374237,"humidity":36.46941012936869}
    12/27/2019 8:51:31 PM > Sending CONTAINER message: {"temperature":21.986403302500637,"humidity":47.847680384455096}
    12/27/2019 8:51:32 PM > Sending TRUCK message: {"temperature":36.10474464823629,"humidity":48.82029906486022}
    12/27/2019 8:51:32 PM > Sending AIRPLANE message: {"temperature":16.55005930170971,"humidity":36.49988437459935}
    12/27/2019 8:51:32 PM > Sending CONTAINER message: {"temperature":21.811727088543286,"humidity":50.0}
    ```

1. Leave the **ContainerSimulation** app running for the remainder of this lab.

    This will ensure device telemetry from the three devices (Container, Truck, and Airplane) is being sent to Azure IoT Hub.

1. After the **ContainerSimulation** app has been running for 30 seconds, you will see a message telling you that the **Container** device is changing transport methods.

    The transport method will change between **Truck** and **Airplane** every 30 seconds. The **Terminal** output will look like the following when this happens:

    ```text
    12/27/2019 8:51:40 PM > CONTAINER transport changed to: TRUCK
    ```

    > **Note**:  In production the shipping container would only change transport methods during the normal course of shipping. For the simulated scenario in this lab, it's performed every 30 seconds to give a short enough data duration that will fit during the course of performing the steps in this lab.

### Exercise 4: View Time Series Insights Explorer

In this exercise, you will get a quick introduction to working with time series data using the Time Series Insights (TSI) Explorer.

1. Switch to the window containing your Azure portal and navigate to your Dashboard.

    If needed, log in to the Azure portal using your Azure account credentials.

1. On your Resource group tile, click **tsi-az220-training-{your-id}**.

1. On the **Time Series Insights environment** blade, at the top of the **Overview** pane, click **Go to TSI Explorer**.

    This will open the **Time Series Insights Explorer** in a new browser tab.

1. On the left-side menu, ensure that **Analyze** is selected.

    You can expand the navigation menu to display the button names. The two options are "Analyze" and "Model". Choose Analyze.

    Collapse the navigation menu to ensure that you can see the query edit area on the left side of the page.

1. To begin to edit a query, click **Add new query**.

1. In the left-side pane, under **Query 1**, open the **MEASURE** dropdown, and then click **temperature**.

1. Open the **SPLIT BY** dropdown, and then click **iothub-connection-device-id**.

    When you run the query, this will split the graph to show the telemetry from each of the IoT Devices separately on the graph.

1. At the top of the page, to have the display automatically refresh, set the **Auto refresh** toggle to **On**.

    When **Auto refresh** is enabled, the display will be updated every _30 seconds_ to display the latest data. This only applies to the last 1 hour of available data.

1. Notice the graph now displays the **temperature** sensor event data from the IoT Devices within Azure IoT Hub in a _Line Chart_.

1. Notice the list of Device IDs to the left of the graph.

    Hovering the mouse over a specific Device ID will highlight it's data on the graph display.

1. Take a moment to examine the temperature data (graphs) for the telemetry streaming into the system from the three simulated devices.

    Notice that the temperature data for the **sensor-th-container0001** is influenced by the temperature of the transport mechanism, either the **sensor-th-truck0001** or the **sensor-th-airplane0001**. This provides an indication whether the sensor-th-container0001 is being transported by Truck or Airplane at those times.

1. To add a second query to the display, click **Add new query**.

1. Under **Query 2**, set the **MEASURE** dropdown to **humidity**, and then set the **SPLIT BY** dropdown to **iothub-connection-device-id**.

    Notice that there are now two graphs displayed. The top graph shows **temperature** while the lower graph shows **humidity**, both using their own Y-axis scale.

1. Position your mouse pointer over one of the graph lines.

    Notice that when you hover the mouse cursor over the graph, a popup will display the details for a point on the graph. The popup displays the minimum (**min**), average (**avg**), and maximum (**max**) values for the data points in the graph (over the short time represented by that point). The time range associated with the selected data point is displayed along the time axis at the bottom of the display.

1. Along the top of the graph area, notice the options that you can use to control graph settings.

1. Click **Change interval size**.

1. On the **Chart setting** pane, change the Interval setting to 15 seconds, and then close **Chart settings**.

    Notice how the appearance of the data changes as you increase the interval.

1. Take a minute to explore the chart settings.

1. Once you have completed exploring the data, switch to the Visual Studio Code window.

1. In Visual Studio Code, stop the container simulator app by pressing **CTRL+C** in the terminal.

1. 
